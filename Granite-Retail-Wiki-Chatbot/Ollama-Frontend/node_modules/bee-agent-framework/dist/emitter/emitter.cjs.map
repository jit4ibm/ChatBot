{"version":3,"sources":["../../src/emitter/emitter.ts"],"names":["Emitter","Serializable","listeners","Set","groupId","namespace","creator","context","trace","constructor","input","Object","prototype","assertValidNamespace","register","root","create","child","slice","pipe","target","on","toBoundedFunction","args","invoke","value","name","isBlocking","once","persistent","destroy","clear","reset","listener","options","delete","registerCallbacks","callbacks","entries","forEach","key","push","cleanup","event","callback","match","matcher","raw","path","createFullPath","RegExp","test","isPath","EmitterError","add","emit","assertValidName","createEvent","data","executions","values","run","Promise","all","id","createRandomHash","createdAt","Date","source","assign","shallowCopy","createSnapshot","Array","from","map","pick","loadSnapshot","snapshot"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAyDO,MAAMA,gBAA0DC,6BAAAA,CAAAA;AAAAA,EAAAA;;;AAC3DC,EAAAA,SAAAA,uBAAgBC,GAAAA,EAAAA;AACPC,EAAAA,OAAAA;AACHC,EAAAA,SAAAA;AACAC,EAAAA,OAAAA;AACAC,EAAAA,OAAAA;AACAC,EAAAA,KAAAA;EAEhBC,WAAYC,CAAAA,KAAAA,GAAsB,EAAI,EAAA;AACpC,IAAK,KAAA,EAAA;AACL,IAAA,IAAA,CAAKN,UAAUM,KAAON,EAAAA,OAAAA;AACtB,IAAKC,IAAAA,CAAAA,SAAAA,GAAYK,KAAOL,EAAAA,SAAAA,IAAa,EAAA;AACrC,IAAKC,IAAAA,CAAAA,OAAAA,GAAUI,KAAMJ,CAAAA,OAAAA,IAAWK,MAAOC,CAAAA,SAAAA;AACvC,IAAKL,IAAAA,CAAAA,OAAAA,GAAUG,KAAOH,EAAAA,OAAAA,IAAW,EAAC;AAClC,IAAA,IAAA,CAAKC,QAAQE,KAAMF,CAAAA,KAAAA;AACnBK,IAAAA,8BAAAA,CAAqB,KAAKR,SAAS,CAAA;AACrC;EAEA;AACE,IAAA,IAAA,CAAKS,QAAQ,EAAA;AACf;AAEA,EAAA,WACWC,IAAO,GAAA;AAChB,IAAA,OAAO,IAAIf,OAAuC,CAAA;MAAEM,OAASK,kBAAAA,MAAAA,CAAOK,OAAO,IAAA;KAAM,CAAA;AACnF;EAEAC,KAAaP,CAAAA,KAAAA,GAA2B,EAAgB,EAAA;AACtD,IAAMO,MAAAA,KAAAA,GAAQ,IAAIjB,OAAW,CAAA;MAC3BQ,KAAOE,EAAAA,KAAAA,CAAMF,SAAS,IAAKA,CAAAA,KAAAA;MAC3BJ,OAASM,EAAAA,KAAAA,EAAON,WAAW,IAAKA,CAAAA,OAAAA;MAChCG,OAAS,EAAA;AAAE,QAAA,GAAG,IAAKA,CAAAA,OAAAA;AAAS,QAAA,GAAGG,KAAOH,EAAAA;AAAQ,OAAA;MAC9CD,OAASI,EAAAA,KAAAA,EAAOJ,WAAW,IAAKA,CAAAA,OAAAA;AAChCD,MAAAA,SAAAA,EAAWK,OAAOL,SACd,GAAA;WAAI,IAAKA,CAAAA,SAAAA;WAAcK,KAAML,CAAAA;AAC7B,OAAA,GAAA,IAAA,CAAKA,UAAUa,KAAK;KAC1B,CAAA;AAEAD,IAAAA,KAAAA,CAAME,KAAK,IAAI,CAAA;AACf,IAAOF,OAAAA,KAAAA;AACT;AAEAE,EAAAA,IAAAA,CAAKC,MAAiC,EAAA;AACpC,IAAA,OAAO,IAAKC,CAAAA,EAAAA;;AAEV,MAAA,KAAA;AACAC,MAAAA,6BAAAA;;AAEE,QAAA,CAAA,GAAIC,IAASH,KAAAA,MAAAA,CAAOI,MAAM,CAAA,GAAID,IAAAA,CAAAA;AAC9B,QAAA;AAAC,UAAA;YAAEE,KAAOL,EAAAA,MAAAA;YAAQM,IAAM,EAAA;AAAS;;AAAE,OAAA;AAErC,MAAA;QACEC,UAAY,EAAA,IAAA;QACZC,IAAM,EAAA,KAAA;QACNC,UAAY,EAAA;AACd;AAAA,KAAA;AAEJ;EAEAC,OAAU,GAAA;AACR,IAAA,IAAA,CAAK5B,UAAU6B,KAAK,EAAA;AACtB;EAEAC,KAAQ,GAAA;AACN,IAAWC,KAAAA,MAAAA,QAAAA,IAAY,KAAK/B,SAAW,EAAA;AACrC,MAAI,IAAA,CAAC+B,QAASC,CAAAA,OAAAA,EAASL,UAAY,EAAA;AACjC,QAAK3B,IAAAA,CAAAA,SAAAA,CAAUiC,OAAOF,QAAAA,CAAAA;AACxB;AACF;AACF;AAEAG,EAAAA,iBAAAA,CACEC,WAGAH,OACW,EAAA;AACX,IAAA,MAAMhC,YAAyB,EAAA;AAC/BS,IAAO2B,MAAAA,CAAAA,OAAAA,CAAQD,SAAAA,CAAWE,CAAAA,OAAAA,CAAQ,CAAC,CAACC,GAAAA,EAAKf,KAAAA,CAAM,KAAA;AAC7C,MAAA,IAAIA,KAAO,EAAA;AAETvB,QAAUuC,SAAAA,CAAAA,IAAAA,CAAK,KAAKpB,EAAGmB,CAAAA,GAAAA,EAAKf,OAAOS,OAAUM,GAAAA,GAAAA,CAAI,CAAA,CAAA;AACnD;KACF,CAAA;AACA,IAAA,OAAO,MAAMtC,SAAUqC,CAAAA,OAAAA,CAAQ,CAACG,OAAAA,KAAYA,SAAAA,CAAAA;AAC9C;EAEArB,EACEsB,CAAAA,KAAAA,EACAC,UACAV,OACW,EAAA;AACX,IAAA,OAAO,IAAKW,CAAAA,KAAAA,CAAMF,KAAkBC,EAAAA,QAAAA,EAA2BV,OAAAA,CAAAA;AACjE;EAEAW,KAASC,CAAAA,OAAAA,EAAkBF,UAAuBV,OAAqC,EAAA;AACrF,IAAA,MAAMD,QAAqB,GAAA;AACzBC,MAAAA,OAAAA;AACAU,MAAAA,QAAAA;MACAG,GAAKD,EAAAA,OAAAA;AACLD,MAAAA,KAAAA,EAAAA,CAAQ,MAAA;AACN,QAAA,IAAIC,YAAY,GAAK,EAAA;AACnB,UAAO,OAAA,CAACH,UAAUA,KAAMK,CAAAA,IAAAA,KAASC,yBAAe,IAAK5C,CAAAA,SAAAA,EAAWsC,MAAMjB,IAAI,CAAA;AAC5E,SAAA,MAAA,IAAWoB,YAAY,KAAO,EAAA;AAC5B,UAAA,OAAO,MAAM,IAAA;AACf,SAAA,MAAA,IAAWA,mBAAmBI,MAAQ,EAAA;AACpC,UAAA,OAAO,CAACP,KAAAA,KAAUG,OAAQK,CAAAA,IAAAA,CAAKR,MAAMK,IAAI,CAAA;SAChC,MAAA,IAAA,OAAOF,YAAY,UAAY,EAAA;AACxC,UAAOA,OAAAA,OAAAA;SACE,MAAA,IAAA,OAAOA,YAAY,QAAU,EAAA;AACtC,UAAA,OAAOM,iBAAON,OAAAA,CAAAA,GACV,CAACH,KAAUA,KAAAA,KAAAA,CAAMK,SAASF,OAC1B,GAAA,CAACH,UACCA,KAAMjB,CAAAA,IAAAA,KAASoB,WAAWH,KAAMK,CAAAA,IAAAA,KAASC,yBAAe,IAAK5C,CAAAA,SAAAA,EAAWsC,MAAMjB,IAAI,CAAA;SACnF,MAAA;AACL,UAAM,MAAA,IAAI2B,wBAAa,2BAAA,CAAA;AACzB;OACF;AACF,KAAA;AACA,IAAKnD,IAAAA,CAAAA,SAAAA,CAAUoD,IAAIrB,QAAAA,CAAAA;AAEnB,IAAA,OAAO,MAAM,IAAA,CAAK/B,SAAUiC,CAAAA,MAAAA,CAAOF,QAAAA,CAAAA;AACrC;EAEA,MAAMsB,IAAAA,CACJ7B,MACAD,KACe,EAAA;AACf+B,IAAAA,yBAAAA,CAAgB9B,IAAAA,CAAAA;AAEhB,IAAMiB,MAAAA,KAAAA,GAAQ,IAAKc,CAAAA,WAAAA,CAAY/B,IAAAA,CAAAA;AAC/B,IAAA,OAAO,MAAM,IAAA,CAAKF,MAAOC,CAAAA,KAAAA,EAAOkB,KAAAA,CAAAA;AAClC;EAEA,MAAgBnB,MAAAA,CAAOkC,MAAef,KAAkB,EAAA;AACtD,IAAA,MAAMgB,aAAwB,EAAA;AAC9B,IAAA,KAAA,MAAW1B,QAAY,IAAA,IAAA,CAAK/B,SAAU0D,CAAAA,MAAAA,EAAU,EAAA;AAC9C,MAAA,IAAI,CAAC3B,QAAAA,CAASY,KAAMF,CAAAA,KAAAA,CAAQ,EAAA;AAC1B,QAAA;AACF;AAEA,MAAIV,IAAAA,QAAAA,CAASC,SAASN,IAAM,EAAA;AAC1B,QAAK1B,IAAAA,CAAAA,SAAAA,CAAUiC,OAAOF,QAAAA,CAAAA;AACxB;AAEA,MAAA,MAAM4B,sBAAkB5B,MAAAA,CAAAA,YAAAA,QAAAA,CAASW,QAASc,CAAAA,IAAAA,EAAMf,KAAAA,CAApC,EAAA,KAAA,CAAA;AACZgB,MAAWlB,UAAAA,CAAAA,IAAAA,CAAKR,SAASC,OAASP,EAAAA,UAAAA,GAAa,MAAMkC,GAAAA,EAAAA,GAAQA,KAAAA,CAAAA;AAC/D;AACA,IAAMC,MAAAA,OAAAA,CAAQC,IAAIJ,UAAAA,CAAAA;AACpB;AAEUF,EAAAA,WAAAA,CAAY/B,IAAyB,EAAA;AAC7C,IAAO,OAAA;AACLsC,MAAAA,EAAAA,EAAIC,yBAAAA,EAAAA;AACJ7D,MAAAA,OAAAA,EAAS,IAAKA,CAAAA,OAAAA;AACdsB,MAAAA,IAAAA;MACAsB,IAAMC,EAAAA,wBAAAA,CAAe,IAAK5C,CAAAA,SAAAA,EAAWqB,IAAAA,CAAAA;AACrCwC,MAAAA,SAAAA,sBAAeC,IAAAA,EAAAA;MACfC,MAAQ,EAAA,IAAA;AACR9D,MAAAA,OAAAA,EAAS,IAAKA,CAAAA,OAAAA;AACdC,MAAAA,OAAAA,EAASI,OAAO0D,MAAO,CAAA,IAAI,IAAK9D,CAAAA,OAAAA,EAAS,EAAC,CAAA;;MAC1CC,KAAO8D,EAAAA,uBAAAA,CAAY,KAAK9D,KAAK;AAC/B,KAAA;AACF;;EAEA+D,cAAiB,GAAA;AACf,IAAO,OAAA;AACLnE,MAAAA,OAAAA,EAAS,IAAKA,CAAAA,OAAAA;MACdC,SAAWiE,EAAAA,uBAAAA,CAAY,KAAKjE,SAAS,CAAA;AACrCC,MAAAA,OAAAA,EAAS,IAAKA,CAAAA,OAAAA;AACdC,MAAAA,OAAAA,EAAS,IAAKA,CAAAA,OAAAA;AACdC,MAAAA,KAAAA,EAAO,IAAKA,CAAAA,KAAAA;AACZN,MAAAA,SAAAA,EAAWsE,MAAMC,IAAK,CAAA,IAAA,CAAKvE,SAAS,CAAA,CAAEwE,IAAIC,WAAK,CAAA;AAAC,QAAA,KAAA;AAAO,QAAA,SAAA;AAAW,QAAA;OAAW,CAAA;AAC/E,KAAA;AACF;AAEAC,EAAAA,YAAAA,CAAa,EAAE1E,SAAAA,EAAW,GAAG2E,QAAAA,EAA0D,EAAA;AACrFlE,IAAO0D,MAAAA,CAAAA,MAAAA,CAAO,MAAMQ,QAAU,EAAA;AAAE3E,MAAAA,SAAAA,sBAAeC,GAAAA;KAAM,CAAA;AACrDD,IAAAA,SAAAA,CAAUqC,OAAQ,CAAA,CAAC,EAAEQ,GAAAA,EAAKH,QAAUV,EAAAA,OAAAA,EAAc,KAAA,IAAA,CAAKW,KAAME,CAAAA,GAAAA,EAAKH,QAAUV,EAAAA,OAAAA,CAAAA,CAAAA;AAC9E;AACF","file":"emitter.cjs","sourcesContent":["/**\n * Copyright 2024 IBM Corp.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Callback,\n  CleanupFn,\n  EmitterOptions,\n  EventMeta,\n  EventTrace,\n  Matcher,\n  StringKey,\n} from \"@/emitter/types.js\";\nexport type { EventMeta, EventTrace, Callback };\nimport { Cache } from \"@/cache/decoratorCache.js\";\nimport { createFullPath, isPath, assertValidName, assertValidNamespace } from \"@/emitter/utils.js\";\nimport { EmitterError } from \"@/emitter/errors.js\";\nimport { createRandomHash } from \"@/internals/helpers/hash.js\";\nimport { shallowCopy, toBoundedFunction } from \"@/serializer/utils.js\";\nimport { RequiredAll } from \"@/internals/types.js\";\nimport { Serializable } from \"@/internals/serializable.js\";\nimport { pick } from \"remeda\";\n\nexport interface EmitterInput<E extends object = object> {\n  groupId?: string;\n  namespace?: string[];\n  creator?: object;\n  context?: E & object;\n  trace?: EventTrace;\n}\nexport interface EmitterChildInput<E extends object = object> {\n  groupId?: string;\n  namespace?: string[];\n  creator?: object;\n  context?: E & object;\n  trace?: EventTrace;\n}\n\ninterface Listener<T = any> {\n  readonly match: (event: EventMeta) => boolean;\n  readonly raw: Matcher;\n  readonly callback: Callback<T>;\n  readonly options?: EmitterOptions;\n}\n\nexport class Emitter<T = Record<keyof any, Callback<unknown>>> extends Serializable {\n  protected listeners = new Set<Listener>();\n  protected readonly groupId?: string;\n  public readonly namespace: string[];\n  public readonly creator?: object;\n  public readonly context: object;\n  public readonly trace?: EventTrace;\n\n  constructor(input: EmitterInput = {}) {\n    super();\n    this.groupId = input?.groupId;\n    this.namespace = input?.namespace ?? [];\n    this.creator = input.creator ?? Object.prototype;\n    this.context = input?.context ?? {};\n    this.trace = input.trace;\n    assertValidNamespace(this.namespace);\n  }\n\n  static {\n    this.register();\n  }\n\n  @Cache()\n  static get root() {\n    return new Emitter<Record<string, Callback<any>>>({ creator: Object.create(null) });\n  }\n\n  child<R = T>(input: EmitterChildInput = {}): Emitter<R> {\n    const child = new Emitter<R>({\n      trace: input.trace ?? this.trace,\n      groupId: input?.groupId ?? this.groupId,\n      context: { ...this.context, ...input?.context },\n      creator: input?.creator ?? this.creator,\n      namespace: input?.namespace\n        ? [...this.namespace, ...input.namespace]\n        : this.namespace.slice(),\n    });\n\n    child.pipe(this);\n    return child;\n  }\n\n  pipe(target: Emitter<any>): CleanupFn {\n    return this.on(\n      // @ts-expect-error\n      \"*.*\",\n      toBoundedFunction(\n        // @ts-expect-error\n        (...args) => target.invoke(...args),\n        [{ value: target, name: \"target\" }],\n      ),\n      {\n        isBlocking: true,\n        once: false,\n        persistent: true,\n      },\n    );\n  }\n\n  destroy() {\n    this.listeners.clear();\n  }\n\n  reset() {\n    for (const listener of this.listeners) {\n      if (!listener.options?.persistent) {\n        this.listeners.delete(listener);\n      }\n    }\n  }\n\n  registerCallbacks<K extends StringKey<RequiredAll<T>>>(\n    callbacks: Partial<\n      Record<K, NonNullable<T[K]> extends Callback<infer X> ? Callback<X> : never>\n    >,\n    options?: Partial<Record<K, EmitterOptions>>,\n  ): CleanupFn {\n    const listeners: CleanupFn[] = [];\n    Object.entries(callbacks).forEach(([key, value]) => {\n      if (value) {\n        // @ts-expect-error\n        listeners.push(this.on(key, value, options?.[key]));\n      }\n    });\n    return () => listeners.forEach((cleanup) => cleanup());\n  }\n\n  on<K extends StringKey<RequiredAll<T>>>(\n    event: K,\n    callback: NonNullable<T[K]> extends Callback<any> ? T[K] : never,\n    options?: EmitterOptions,\n  ): CleanupFn {\n    return this.match(event as Matcher, callback as Callback<any>, options);\n  }\n\n  match<L>(matcher: Matcher, callback: Callback<L>, options?: EmitterOptions): CleanupFn {\n    const listener: Listener = {\n      options,\n      callback,\n      raw: matcher,\n      match: (() => {\n        if (matcher === \"*\") {\n          return (event) => event.path === createFullPath(this.namespace, event.name);\n        } else if (matcher === \"*.*\") {\n          return () => true;\n        } else if (matcher instanceof RegExp) {\n          return (event) => matcher.test(event.path);\n        } else if (typeof matcher === \"function\") {\n          return matcher;\n        } else if (typeof matcher === \"string\") {\n          return isPath(matcher)\n            ? (event) => event.path === matcher\n            : (event) =>\n                event.name === matcher && event.path === createFullPath(this.namespace, event.name);\n        } else {\n          throw new EmitterError(\"Invalid matcher provided!\");\n        }\n      })(),\n    };\n    this.listeners.add(listener);\n\n    return () => this.listeners.delete(listener);\n  }\n\n  async emit<K extends StringKey<RequiredAll<T>>>(\n    name: K,\n    value: NonNullable<T[K]> extends Callback<infer X> ? X : unknown,\n  ): Promise<void> {\n    assertValidName(name);\n\n    const event = this.createEvent(name);\n    return await this.invoke(value, event);\n  }\n\n  protected async invoke(data: unknown, event: EventMeta) {\n    const executions: unknown[] = [];\n    for (const listener of this.listeners.values()) {\n      if (!listener.match(event)) {\n        continue;\n      }\n\n      if (listener.options?.once) {\n        this.listeners.delete(listener);\n      }\n\n      const run = async () => listener.callback(data, event);\n      executions.push(listener.options?.isBlocking ? await run() : run());\n    }\n    await Promise.all(executions);\n  }\n\n  protected createEvent(name: string): EventMeta {\n    return {\n      id: createRandomHash(),\n      groupId: this.groupId,\n      name,\n      path: createFullPath(this.namespace, name),\n      createdAt: new Date(),\n      source: this,\n      creator: this.creator!,\n      context: Object.assign({}, this.context, {}), // TODO: use createInStone\n      trace: shallowCopy(this.trace), // TODO\n    };\n  }\n\n  createSnapshot() {\n    return {\n      groupId: this.groupId,\n      namespace: shallowCopy(this.namespace),\n      creator: this.creator,\n      context: this.context,\n      trace: this.trace,\n      listeners: Array.from(this.listeners).map(pick([\"raw\", \"options\", \"callback\"])),\n    };\n  }\n\n  loadSnapshot({ listeners, ...snapshot }: ReturnType<typeof this.createSnapshot>): void {\n    Object.assign(this, snapshot, { listeners: new Set() });\n    listeners.forEach(({ raw, callback, options }) => this.match(raw, callback, options));\n  }\n}\n"]}